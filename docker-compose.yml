# --- Файл: docker-compose.yml (ПОЛНАЯ И ПРАВИЛЬНАЯ ВЕРСИЯ ДЛЯ SAGA) ---
services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672" # Порт для обмена сообщениями
      - "15672:15672" # Веб-интерфейс для управления
    networks: [marketplace-net]
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Consul можно закомментировать или удалить, если он не используется auth-service
  # Но оставим его, так как auth-service на него завязан
  consul:
    image: consul:1.15
    container_name: consul
    ports: ["8500:8500"]
    command: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0
    networks: [marketplace-net]
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Сервис аутентификации остается без изменений, он нужен для получения токена
  auth-service-1:
    build: ./services/auth-service
    container_name: auth-service-1
    ports: ["8081:3001"]
    volumes: ["./docs:/usr/src/app/docs:ro"]
    environment:
      - PORT=3001
      - JWT_SECRET=super-secret-jwt-key-change-in-production
      - JWT_EXPIRES_IN=24h
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_HOST=auth-service-1
    depends_on:
      consul: { condition: service_healthy }
    networks: [marketplace-net]
    restart: unless-stopped

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks: [marketplace-net]

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka
    depends_on: [zookeeper]
    ports: ["9092:9092"]
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks: [marketplace-net]
    healthcheck:
      test:
        [
          "CMD",
          "kafka-broker-api-versions",
          "--bootstrap-server",
          "localhost:9092",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Order Service теперь зависит от RabbitMQ
  order-service-1:
    build: ./services/order-service
    container_name: order-service-1
    ports: ["8083:3003"]
    environment:
      - PORT=3003
      - JWT_SECRET=super-secret-jwt-key-change-in-production
      - RABBITMQ_URL=amqp://rabbitmq
      - PAYMENT_SERVICE_GRPC=payment-service:50051
      - KAFKA_BROKER=kafka:29092 # <-- Адрес Kafka внутри сети
    depends_on:
      rabbitmq: { condition: service_healthy }
      kafka: { condition: service_healthy }
    networks: [marketplace-net]
    restart: unless-stopped

  analytics-service:
    build: ./services/analytics-service
    container_name: analytics-service
    ports: ["3004:3004"]
    environment:
      - PORT=3004
      - KAFKA_BROKER=kafka:29092
    depends_on:
      kafka: { condition: service_healthy }
    networks: [marketplace-net]
    restart: unless-stopped

  # Cервис для обработки платежей
  payment-service:
    build: ./services/payment-service
    container_name: payment-service
    environment:
      - RABBITMQ_URL=amqp://rabbitmq
      - GRPC_PORT=50051
    ports:
      # Экспонируем порт, если захотим тестировать локально (опционально)
      - "50051:50051"
    depends_on:
      rabbitmq: { condition: service_healthy }
    networks: [marketplace-net]
    restart: unless-stopped

  # Новый сервис для отправки уведомлений
  notification-service:
    build: ./services/notification-service
    container_name: notification-service
    environment:
      - RABBITMQ_URL=amqp://rabbitmq
    depends_on:
      rabbitmq: { condition: service_healthy }
    networks: [marketplace-net]
    restart: unless-stopped

  # NGINX теперь проксирует запросы только на нужные нам сервисы
  nginx-gateway:
    image: nginx:alpine
    container_name: nginx-gateway
    volumes: ["./gateway/nginx.conf:/etc/nginx/conf.d/default.conf:ro"]
    ports: ["8080:8080"]
    depends_on:
      - auth-service-1
      - order-service-1
    networks: [marketplace-net]
    restart: unless-stopped

networks:
  marketplace-net:
    driver: bridge
