# --- Файл: docker-compose.yml (ПОЛНАЯ И ПРАВИЛЬНАЯ ВЕРСИЯ ДЛЯ SAGA) ---
services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672" # Порт для обмена сообщениями
      - "15672:15672" # Веб-интерфейс для управления
    networks: [marketplace-net]
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Consul можно закомментировать или удалить, если он не используется auth-service
  # Но оставим его, так как auth-service на него завязан
  consul:
    image: consul:1.15
    container_name: consul
    ports: ["8500:8500"]
    command: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0
    networks: [marketplace-net]
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Сервис аутентификации остается без изменений, он нужен для получения токена
  auth-service-1:
    build: ./services/auth-service
    container_name: auth-service-1
    ports: ["8081:3001"]
    volumes: ["./docs:/usr/src/app/docs:ro"]
    environment:
      - PORT=3001
      - JWT_SECRET=super-secret-jwt-key-change-in-production
      - JWT_EXPIRES_IN=24h
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_HOST=auth-service-1
    depends_on:
      consul: { condition: service_healthy }
    networks: [marketplace-net]
    restart: unless-stopped

  # Order Service теперь зависит от RabbitMQ
  order-service-1:
    build: ./services/order-service
    container_name: order-service-1
    ports: ["8083:3003"]
    environment:
      - PORT=3003
      - JWT_SECRET=super-secret-jwt-key-change-in-production
      - RABBITMQ_URL=amqp://rabbitmq # <-- Переменная для подключения к RabbitMQ
      - PAYMENT_SERVICE_GRPC=payment-service:50051 # <-- Адрес gRPC сервиса платежей
    depends_on:
      rabbitmq: { condition: service_healthy } # <-- Запускается только после RabbitMQ
    networks: [marketplace-net]
    restart: unless-stopped

  # Cервис для обработки платежей
  payment-service:
    build: ./services/payment-service
    container_name: payment-service
    environment:
      - RABBITMQ_URL=amqp://rabbitmq
      - GRPC_PORT=50051
    ports:
      # Экспонируем порт, если захотим тестировать локально (опционально)
      - "50051:50051"
    depends_on:
      rabbitmq: { condition: service_healthy }
    networks: [marketplace-net]
    restart: unless-stopped

  # Новый сервис для отправки уведомлений
  notification-service:
    build: ./services/notification-service
    container_name: notification-service
    environment:
      - RABBITMQ_URL=amqp://rabbitmq
    depends_on:
      rabbitmq: { condition: service_healthy }
    networks: [marketplace-net]
    restart: unless-stopped

  # NGINX теперь проксирует запросы только на нужные нам сервисы
  nginx-gateway:
    image: nginx:alpine
    container_name: nginx-gateway
    volumes: ["./gateway/nginx.conf:/etc/nginx/conf.d/default.conf:ro"]
    ports: ["8080:8080"]
    depends_on:
      - auth-service-1
      - order-service-1
    networks: [marketplace-net]
    restart: unless-stopped

networks:
  marketplace-net:
    driver: bridge
