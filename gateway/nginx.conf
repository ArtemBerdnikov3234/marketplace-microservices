# --- File: gateway/nginx.conf ---

events {
    # Базовая настройка: сколько соединений может обработать один рабочий процесс
    worker_connections 1024;
}

http {
    # Подключаем стандартные типы файлов
    include       /etc/nginx/mime.types;
    default_type  application/json;

    # Настройка логов в формате JSON (для удобного чтения в Loki/Grafana)
    log_format json_combined escape=json
      '{'
        '"time_local":"$time_local",'
        '"remote_addr":"$remote_addr",'
        '"request":"$request",'
        '"status": "$status",'
        '"request_time":"$request_time",'
        '"upstream_response_time":"$upstream_response_time",'
        '"http_user_agent":"$http_user_agent"'
      '}';

    access_log /var/log/nginx/access.log json_combined;
    error_log /var/log/nginx/error.log warn;

    # =========================================================================
    # ВАШ КОД НАЧИНАЕТСЯ ЗДЕСЬ (Zones, Upstreams, Server)
    # =========================================================================

    # Зоны для rate limiting
    limit_req_zone $binary_remote_addr zone=general_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/s;
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=20r/s;

    # Upstreams (ссылаются на имена контейнеров из docker-compose)
    upstream auth_service {
        server auth-service-1:3001 max_fails=3 fail_timeout=30s;
    }

    upstream catalog_service {
        server catalog-service-1:3002 max_fails=3 fail_timeout=30s;
    }

    upstream order_service {
        server order-service-1:3003 max_fails=3 fail_timeout=30s;
    }

    server {
        listen 8080;
        server_name localhost;

        # Таймауты
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Auth endpoints - строгий rate limit (5 req/sec)
        location /api/auth/ {
            limit_req zone=auth_limit burst=10 nodelay;
            limit_req_status 429;
            
            proxy_pass http://auth_service/api/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Products - СТРОГИЙ rate limit для теста (10 req/sec)
        location /api/products/ {
            # ВАЖНО: burst=5 означает что после 10 запросов/сек будет блокировка
            limit_req zone=general_limit burst=5 nodelay;
            limit_req_status 429;
            
            proxy_pass http://catalog_service/api/products/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Wishlist
        location /api/wishlist/ {
            limit_req zone=api_limit burst=15 nodelay;
            limit_req_status 429;
            
            proxy_pass http://catalog_service/api/wishlist/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }
        
        # Orders
        location /api/orders/ {
            limit_req zone=api_limit burst=15 nodelay;
            limit_req_status 429;
            
            proxy_pass http://order_service/api/orders/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Health check - без ограничений
        location /health {
            access_log off;
            return 200 'NGINX is up\n';
            add_header Content-Type text/plain;
        }

        # Обработка ошибок rate limiting
        error_page 429 /rate_limit.json;
        location = /rate_limit.json {
            internal;
            default_type application/json;
            return 429 '{"error":"Too many requests. Please slow down.","status":429}\n';
        }

        # Обработка других ошибок
        error_page 502 503 504 /50x.json;
        location = /50x.json {
            internal;
            default_type application/json;
            return 503 '{"error":"Service temporarily unavailable","status":503}\n';
        }
    }
}